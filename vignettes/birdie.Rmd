---
title: "Estimation of Racial Disparities when Race is Not Observed"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimation of Racial Disparities when Race is Not Observed}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This document will walk you through how to use `birdie`. First, load in the package.

```{r setup, message=FALSE}
library(birdie)
library(dplyr)
```

For a concrete example, we'll use some fake voter file data.
Our goal is to estimate turnout rates by race.

```{r}
data(pseudo_vf)

print(pseudo_vf)
```

You'll notice that we have a `race` column in our data.
That will allow us to check our work once we're done.
For now, we'll generate the *true* distribution of turnout and race, along with the marginal distribution of each variable.

```{r}
p_xr = prop.table(table(pseudo_vf$turnout, pseudo_vf$race))
p_x = rowSums(p_xr)
p_r = colSums(p_xr)
```

There are two steps to applying the `birdie` methodology:

1. Generate a first set of individual race probabilities using Bayesian Improved Surname Geocoding (`bisg()`).
1. For a specific outcome variable of interest, run a Bayesian Instrumental Regression for Disparity Estimation (`birdie()`) model to come up with estimated probabilities conditional on race.

## Generating BISG probabilities

For the first step, you can use any BISG software, including the [`wru` R package](https://cran.r-project.org/package=wru).
However, `birdie` provides its own `bisg()` function to make this easy and very computationally efficient.
To use `bisg()`, you provide a formula that labels the predictors used.
You use `nm()` to show which variable contains last names, which must always be provided.
ZIP codes and states can be labeled with `zip()` and `state()`.
Other types of geographies can be used as well---just read the documentation for `bisg()`.

```{r}
r_probs = bisg(~ nm(last_name) + zip(zip), data=pseudo_vf, p_r=p_r)
print(r_probs)
```

Each row `r_probs` matches a row in `pseudo_vf`.
It's important to note that here we are assuming that we know the overall racial distribution of our population (registered voters).
Because of that, we provide the `p_r=p_r` argument, which gives `bisg()` the overall racial distribution.
If you don't know the overall racial distribution in your context (even a guess is better than nothing), then you could pass in something like the national distribution of race (which is conveniently provided by `p_r_natl()`).

## Estimating distributions by race

We're now ready to estimate turnout by race.
For this we'll use the `birdie()` function, and provide it with a formula describing our BIRDiE model, including our variable of interest `turnout`.<!-- and our geography variable `zip`.-->
`birdie()` knows how to handle the columns of `r_probs` because they came from this package.
If you use a different package, the columns may be named differently.
The `prefix` parameter to `birdie()` lets you specify the naming convention for your probabilities.

```{r}
fit = birdie(r_probs, turnout ~ 1, data=pseudo_vf)
print(fit)
```
