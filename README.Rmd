---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
set.seed(5118)
```

# **BIRDiE**: Estimating disparities when race is not observed <img src="man/figures/logo.png" align="right" height="156" />

<!-- badges: start -->
[![R-CMD-check](https://github.com/CoryMcCartan/birdie/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/CoryMcCartan/birdie/actions/workflows/R-CMD-check.yaml)
[![CRAN_Status_Badge](https://www.r-pkg.org/badges/version-last-release/birdie)](https://cran.r-project.org/package=birdie)
![CRAN downloads](http://cranlogs.r-pkg.org/badges/grand-total/birdie)
<!-- badges: end -->

Bayesian Improved Surname Geocoding (BISG) is a simple model that predicts
individual race based off last names and addresses.  While predictive, it
is not perfect, and measurement error in these predictions can cause problems
in downstream analyses.

Bayesian Instrumental Regression for Disparity Estimation (BIRDiE) is a class of
Bayesian models for accurately estimating conditional distributions by race,
using BISG probabilities as inputs.
This package implements BIRDiE as described in [McCartan, Fisher, Goldin, Ho, and Imai (2025)](https://doi.org/10.1080/01621459.2025.2526695).
It also implements standard BISG and an improved measurement-error BISG model as described
in [Imai, Olivella, and Rosenman (2022)](https://www.science.org/doi/full/10.1126/sciadv.adc9824).

```{=html}
<details>
<summary><b>Do I need BIRDiE?</b></summary>
<p>
BIRDiE is a statistical model to let you estimate the average value of a variable in different racial groups.
To take an example from our research paper, if your data are tax records and you want to estimate the rate at which different racial groups take a certain tax credit, BIRDiE can help you do that.
</p>
<p>
BIRDiE is applied on top of individual-level imputations/predictions of race from methods like BISG.
If your only goal is to estimate individual race probabilities, then BIRDiE is not helpful&mdash;BISG alone suffices.
The graphic below gives an overview of the problem BIRDiE solves and how it fits together with existing methods.
</p>
<p>
<img src="man/figures/poster.svg" style="width: 100%" alt="BIRDiE Overview Poster" />
</p>
</details>
```

```{=html}
<details>
<summary><b>What is the difference between BIRDiE and BISG?</b></summary>
<p>
BISG is a simple model that estimates the probability of each individual belonging to diferent racial groups, based on their last name and/or residence location.
</p>
<p>
BIRDiE is a statistical model that takes race probabilities (like BISG) as <i>inputs</i> to estimate the average value of an outcome variable in different racial groups.
If your research question involves both race and another (outcome) variable, then you likely need to apply BIRDiE on top of BISG to avoid biases caused by measurement error in BISG predictions.
</p>
</details>
```

```{=html}
<details>
<summary><b>Is BIRDiE better than BISG, fBISG, etc?</b></summary>
<p>
There are many methods for imputing or predicting individual race, including BISG, fBISG, and others.
Mainly, these methods use different data sources or slightly different models.
</p>
<p>
BIRDiE is <i>not</i> a replacement for these methods, but rather a complementary tool that uses the outputs of these methods to properly estimate disparities in other variables.
When BIRDiE is applied on top of these methods, it generally produces far more accurate estimates than directly thresholding or weighting by the outputs of the prediction methods alone.
</p>
</details>
```


```{=html}
<details>
<summary><b>Do I have to use the <code>birdie</code> software to do BISG?</b></summary>
<p>
The <code>birdie</code> software includes, for convenience, an implementation of basic BISG.
More complicated BISG models that use more data are possible using <code>birdie</code>, but may be easier with other software packages, such as <code>wru</code>.
The BIRDiE method, found in the <code>birdie()</code> function here, can take race predictions from <i>any</i> software package as inputs.
</p>
</details>
```


## Installation

You can install the latest version of the package from CRAN with:

``` r
install.packages("birdie")
```

You can also install the development version with:

``` r
# install.packages("remotes")
remotes::install_github("CoryMcCartan/birdie")
```

## Basic Usage

A basic analysis has two steps.
First, you compute BISG probability estimates with the `bisg()` or `bisg_me()` functions (or using any other probabilistic race prediction tool).
Then, you estimate the distribution of an outcome variable by race using the `birdie()` function.

```{r}
library(birdie)

data(pseudo_vf)

head(pseudo_vf)
```

To compute BISG probabilities, you provide the last name and (optionally) geography variables as part of a formula.

```{r}
r_probs = bisg(~ nm(last_name) + zip(zip), data=pseudo_vf)

head(r_probs)
```

Computing regression estimates requires specifying a model structure.
Here, we'll use a Categorical-Dirichlet regression model that lets the
relationship between turnout and race vary by ZIP code.
This is the "no-pooling" model from McCartan et al.
We'll use Gibbs sampling for inference, which will also let us capture the uncertainty in our estimates.

```{r}
fit = birdie(r_probs, turnout ~ proc_zip(zip), data=pseudo_vf,
             family=cat_dir(), algorithm="gibbs")

print(fit)
```

The `proc_zip()` function fills in missing ZIP codes, among other things.
We can extract the estimated conditional distributions with `coef()`.
We can also get updated BISG probabilities that additionally condition on turnout using `fitted()`.
Additional functions allow us to extract a tidy version of our estimates (`tidy()`)
and visualize the estimated distributions (`plot()`).

```{r}
coef(fit)

head(fitted(fit))

tidy(fit)

plot(fit)
```

A more detailed introduction to the method and software package can be found
on the [Get Started](https://corymccartan.com/birdie/articles/birdie.html) page.
